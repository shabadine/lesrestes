{% extends 'base.html.twig' %}

{% block title %}Publier une nouvelle recette - Les Restes{% endblock %}

{% block body %}
<div class="container my-4">
    <div class="mb-4">
        <a href="{{ path('app_profil') }}" class="btn btn-outline-success">
            <i class="bi bi-arrow-left"></i> Retour à mon profil
        </a>
    </div>
    
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <h1 class="text-success mb-4">Publier une nouvelle recette</h1>
            
            {{ form_start(form, {'attr': {'id': 'recette-form', 'novalidate': 'novalidate'}}) }}
            
            {# --- INFORMATIONS GÉNÉRALES --- #}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="mb-3">
                        {{ form_label(form.nom, 'Titre de la recette', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                        {{ form_widget(form.nom, {'attr': {'class': 'form-control', 'placeholder': 'Ex: Omelette anti-gaspi'}}) }}
                        {{ form_errors(form.nom) }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form_label(form.description, 'Description', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                        {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': 3}}) }}
                        {{ form_errors(form.description) }}
                    </div>
                    
                    <div class="mb-0">
                        {{ form_label(form.imageFile, 'Photo de la recette', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                        {{ form_widget(form.imageFile, {'attr': {'class': 'form-control'}}) }}
                        <small class="text-muted">JPG, PNG ou WebP (max 5Mo)</small>
                        {{ form_errors(form.imageFile) }}
                    </div>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    {{ form_label(form.tempsCuisson, 'Temps (min)', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                    {{ form_widget(form.tempsCuisson, {'attr': {'class': 'form-control'}}) }}
                </div>
                <div class="col-md-6">
                    {{ form_label(form.nombrePersonnes, 'Nombre de personnes', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                    {{ form_widget(form.nombrePersonnes, {'attr': {'class': 'form-control'}}) }}
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold d-block">Difficulté</label>
                {{ form_widget(form.difficulte) }}
            </div>
            
            <hr class="my-4">
            
            {# --- SECTION INGRÉDIENTS --- #}
            <h2 class="h5 text-success mb-3">Ingrédients</h2>
            <div id="ingredients-collection" 
                 class="mb-3" 
                 data-index="{{ form.recetteIngredients|length }}"
                 {# Le prototype doit être généré via form_widget pour que ton JS trouve les inputs/selects #}
                 data-prototype="{{ form_widget(form.recetteIngredients.vars.prototype)|e('html_attr') }}">
                
                {% for row in form.recetteIngredients %}
                    {{ include('partials/_ingredient_row.html.twig', { 'form': row }) }}
                {% endfor %}
            </div>

            <button type="button" class="btn btn-outline-success btn-sm mb-4" id="add-ingredient">
                <i class="bi bi-plus-lg"></i> Ajouter un ingrédient
            </button>
            
            <hr class="my-4">
            
            {# --- ÉTAPES (MATCH AVEC TON JS) --- #}
            <h2 class="h5 text-success mb-3">Étapes de préparation</h2>
            
            <div id="etapes-collection" class="mb-3">
                {# Ton JS injecte les .etape-row ici #}
            </div>

            <button type="button" class="btn btn-outline-success btn-sm mb-4" id="add-etape">
                <i class="bi bi-plus-lg"></i> Ajouter une étape
            </button>

            <div class="d-none">
                {# Ton JS cherche cet ID pour remplir la chaîne de caractères finale #}
                {{ form_widget(form.etapes) }}
            </div>
            {{ form_errors(form.etapes) }}
            
            <hr class="my-4">

            <div class="mb-4">
                {{ form_label(form.categorie, 'Catégorie', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                {{ form_widget(form.categorie, {'attr': {'class': 'form-select'}}) }}
            </div>
            
            <div class="d-flex justify-content-between mt-5 mb-5">
                <a href="{{ path('app_profil') }}" class="btn btn-outline-secondary">Annuler</a>
                <button type="submit" class="btn btn-success px-5 shadow-sm">
                    <i class="bi bi-check-circle"></i> Publier ma recette
                </button>
            </div>

            {# Rend les champs restants (comme le token CSRF) #}
            {{ form_rest(form) }}
            {{ form_end(form) }}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/recipe-form.js') }}"></script>
{% endblock %}